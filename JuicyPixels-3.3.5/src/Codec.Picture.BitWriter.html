<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Rank2Types #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | This module implement helper functions to read &amp; write data</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- at bits level.</span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Codec.Picture.BitWriter</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier">BoolReader</span></a></span><span>
</span><span id="line-7"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#emptyBoolState"><span class="hs-identifier">emptyBoolState</span></a></span><span>
</span><span id="line-8"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier">BoolState</span></a></span><span>
</span><span id="line-9"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#byteAlignJpg"><span class="hs-identifier">byteAlignJpg</span></a></span><span>
</span><span id="line-10"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitsLSBFirst"><span class="hs-identifier">getNextBitsLSBFirst</span></a></span><span>
</span><span id="line-11"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitsMSBFirst"><span class="hs-identifier">getNextBitsMSBFirst</span></a></span><span> </span><span>
</span><span id="line-12"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitJpg"><span class="hs-identifier">getNextBitJpg</span></a></span><span>
</span><span id="line-13"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextIntJpg"><span class="hs-identifier">getNextIntJpg</span></a></span><span>
</span><span id="line-14"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#setDecodedString"><span class="hs-identifier">setDecodedString</span></a></span><span>
</span><span id="line-15"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#setDecodedStringMSB"><span class="hs-identifier">setDecodedStringMSB</span></a></span><span>
</span><span id="line-16"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier">setDecodedStringJpg</span></a></span><span>
</span><span id="line-17"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#runBoolReader"><span class="hs-identifier">runBoolReader</span></a></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier">BoolWriteStateRef</span></a></span><span> </span><span>
</span><span id="line-20"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#newWriteStateRef"><span class="hs-identifier">newWriteStateRef</span></a></span><span>
</span><span id="line-21"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#finalizeBoolWriter"><span class="hs-identifier">finalizeBoolWriter</span></a></span><span>
</span><span id="line-22"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#finalizeBoolWriterGif"><span class="hs-identifier">finalizeBoolWriterGif</span></a></span><span>
</span><span id="line-23"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#writeBits%27"><span class="hs-identifier">writeBits'</span></a></span><span>
</span><span id="line-24"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#writeBitsGif"><span class="hs-identifier">writeBitsGif</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#initBoolState"><span class="hs-identifier">initBoolState</span></a></span><span> </span><span>
</span><span id="line-27"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#initBoolStateJpg"><span class="hs-identifier">initBoolStateJpg</span></a></span><span>
</span><span id="line-28"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#execBoolReader"><span class="hs-identifier">execBoolReader</span></a></span><span>
</span><span id="line-29"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#runBoolReaderWith"><span class="hs-identifier">runBoolReaderWith</span></a></span><span>
</span><span id="line-30"></span><span>                              </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span class="hs-cpp">

#if !MIN_VERSION_base(4,8,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.STRef</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.ST</span></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Int</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Int32</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Word8</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Word32</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bits</span></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">(.&amp;.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.|.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeShiftR</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeShiftL</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Codec.Picture.VectorByteConversion.html"><span class="hs-identifier">Codec.Picture.VectorByteConversion</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Codec.Picture.VectorByteConversion.html#blitVector"><span class="hs-identifier">blitVector</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector.Storable.Mutable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector.Storable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VS</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-52"></span><span class="hs-comment">----            Reader</span><span>
</span><span id="line-53"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- | Current bit index, current value, string</span><span>
</span><span id="line-55"></span><span class="hs-keyword">data</span><span> </span><span id="BoolState"><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BoolState"><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span></span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-56"></span><span>                           </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-57"></span><span>                           </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="annot"><a href="Codec.Picture.BitWriter.html#emptyBoolState"><span class="hs-identifier hs-type">emptyBoolState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span>
</span><span id="line-60"></span><span id="emptyBoolState"><span class="annot"><span class="annottext">emptyBoolState :: BoolState
</span><a href="Codec.Picture.BitWriter.html#emptyBoolState"><span class="hs-identifier hs-var hs-var">emptyBoolState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">-- | Type used to read bits</span><span>
</span><span id="line-63"></span><span class="hs-keyword">type</span><span> </span><span id="BoolReader"><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-var">BoolReader</span></a></span></span><span> </span><span id="local-6989586621679165378"><span class="annot"><a href="#local-6989586621679165378"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679165377"><span class="annot"><a href="#local-6989586621679165377"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.StateT</span></span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165378"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679165377"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span id="local-6989586621679165375"><span id="local-6989586621679165376"><span class="annot"><a href="Codec.Picture.BitWriter.html#runBoolReader"><span class="hs-identifier hs-type">runBoolReader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165376"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165375"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165376"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165375"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-66"></span><span id="runBoolReader"><span class="annot"><span class="annottext">runBoolReader :: BoolReader s a -&gt; ST s a
</span><a href="Codec.Picture.BitWriter.html#runBoolReader"><span class="hs-identifier hs-var hs-var">runBoolReader</span></a></span></span><span> </span><span id="local-6989586621679165374"><span class="annot"><span class="annottext">BoolReader s a
</span><a href="#local-6989586621679165374"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolReader s a -&gt; BoolState -&gt; ST s a
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">S.evalStateT</span></span><span> </span><span class="annot"><span class="annottext">BoolReader s a
</span><a href="#local-6989586621679165374"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; ST s a) -&gt; BoolState -&gt; ST s a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span id="local-6989586621679165371"><span id="local-6989586621679165372"><span class="annot"><a href="Codec.Picture.BitWriter.html#runBoolReaderWith"><span class="hs-identifier hs-type">runBoolReaderWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165372"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165371"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165372"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679165371"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-69"></span><span id="runBoolReaderWith"><span class="annot"><span class="annottext">runBoolReaderWith :: BoolState -&gt; BoolReader s a -&gt; ST s (a, BoolState)
</span><a href="Codec.Picture.BitWriter.html#runBoolReaderWith"><span class="hs-identifier hs-var hs-var">runBoolReaderWith</span></a></span></span><span> </span><span id="local-6989586621679165370"><span class="annot"><span class="annottext">BoolState
</span><a href="#local-6989586621679165370"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679165369"><span class="annot"><span class="annottext">BoolReader s a
</span><a href="#local-6989586621679165369"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolReader s a -&gt; BoolState -&gt; ST s (a, BoolState)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">S.runStateT</span></span><span> </span><span class="annot"><span class="annottext">BoolReader s a
</span><a href="#local-6989586621679165369"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">BoolState
</span><a href="#local-6989586621679165370"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span id="local-6989586621679165366"><span id="local-6989586621679165367"><span class="annot"><a href="Codec.Picture.BitWriter.html#execBoolReader"><span class="hs-identifier hs-type">execBoolReader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165367"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165366"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165367"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span></span></span><span>
</span><span id="line-72"></span><span id="execBoolReader"><span class="annot"><span class="annottext">execBoolReader :: BoolState -&gt; BoolReader s a -&gt; ST s BoolState
</span><a href="Codec.Picture.BitWriter.html#execBoolReader"><span class="hs-identifier hs-var hs-var">execBoolReader</span></a></span></span><span> </span><span id="local-6989586621679165365"><span class="annot"><span class="annottext">BoolState
</span><a href="#local-6989586621679165365"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679165364"><span class="annot"><span class="annottext">BoolReader s a
</span><a href="#local-6989586621679165364"><span class="hs-identifier hs-var">reader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolReader s a -&gt; BoolState -&gt; ST s BoolState
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">S.execStateT</span></span><span> </span><span class="annot"><span class="annottext">BoolReader s a
</span><a href="#local-6989586621679165364"><span class="hs-identifier hs-var">reader</span></a></span><span> </span><span class="annot"><span class="annottext">BoolState
</span><a href="#local-6989586621679165365"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="annot"><a href="Codec.Picture.BitWriter.html#initBoolState"><span class="hs-identifier hs-type">initBoolState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span>
</span><span id="line-75"></span><span id="initBoolState"><span class="annot"><span class="annottext">initBoolState :: ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#initBoolState"><span class="hs-identifier hs-var hs-var">initBoolState</span></a></span></span><span> </span><span id="local-6989586621679165362"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165362"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165362"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-76"></span><span>     </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-77"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679165360"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165360"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165359"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165359"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165360"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165359"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="annot"><a href="Codec.Picture.BitWriter.html#initBoolStateJpg"><span class="hs-identifier hs-type">initBoolStateJpg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span>
</span><span id="line-80"></span><span id="initBoolStateJpg"><span class="annot"><span class="annottext">initBoolStateJpg :: ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#initBoolStateJpg"><span class="hs-identifier hs-var hs-var">initBoolStateJpg</span></a></span></span><span> </span><span id="local-6989586621679165358"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165358"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-81"></span><span>   </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165358"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-82"></span><span>     </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-83"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xFF</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165357"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165357"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165357"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-84"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-85"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x00</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165356"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165356"><span class="hs-identifier hs-var">afterMarker</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xFF</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165356"><span class="hs-identifier hs-var">afterMarker</span></a></span><span>
</span><span id="line-86"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165355"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165355"><span class="hs-identifier hs-var">afterMarker</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#initBoolStateJpg"><span class="hs-identifier hs-var">initBoolStateJpg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165355"><span class="hs-identifier hs-var">afterMarker</span></a></span><span>
</span><span id="line-87"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679165354"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165354"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165353"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165353"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165354"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165353"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | Bitify a list of things to decode.</span><span>
</span><span id="line-90"></span><span id="local-6989586621679165352"><span class="annot"><a href="Codec.Picture.BitWriter.html#setDecodedString"><span class="hs-identifier hs-type">setDecodedString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165352"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-91"></span><span id="setDecodedString"><span class="annot"><span class="annottext">setDecodedString :: ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedString"><span class="hs-identifier hs-var hs-var">setDecodedString</span></a></span></span><span> </span><span id="local-6989586621679165351"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165351"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165351"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-92"></span><span>     </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-93"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679165349"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165349"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165348"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165348"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165349"><span class="hs-identifier hs-var">v</span></a></span><span>    </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165348"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- | Drop all bit until the bit of indice 0, usefull to parse restart</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- marker, as they are byte aligned, but Huffman might not.</span><span>
</span><span id="line-97"></span><span id="local-6989586621679165347"><span class="annot"><a href="Codec.Picture.BitWriter.html#byteAlignJpg"><span class="hs-identifier hs-type">byteAlignJpg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165347"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-98"></span><span id="byteAlignJpg"><span class="annot"><span class="annottext">byteAlignJpg :: BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#byteAlignJpg"><span class="hs-identifier hs-var hs-var">byteAlignJpg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span id="local-6989586621679165346"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165346"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679165345"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165345"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT BoolState (ST s) BoolState
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">S.get</span></span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; BoolReader s () -&gt; BoolReader s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165346"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; BoolReader s ()
forall s. ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier hs-var">setDecodedStringJpg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165345"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span id="local-6989586621679165342"><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitJpg"><span class="hs-identifier hs-type">getNextBitJpg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165342"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-103"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitJpg"><span class="hs-pragma hs-type">getNextBitJpg</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-104"></span><span id="getNextBitJpg"><span class="annot"><span class="annottext">getNextBitJpg :: BoolReader s Bool
</span><a href="Codec.Picture.BitWriter.html#getNextBitJpg"><span class="hs-identifier hs-var hs-var">getNextBitJpg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span id="local-6989586621679165341"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165341"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621679165340"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165340"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679165339"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165339"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT BoolState (ST s) BoolState
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">S.get</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165338"><span class="annot"><span class="annottext">val :: Bool
</span><a href="#local-6989586621679165338"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165340"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165341"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165341"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BoolReader s ()
forall s. ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier hs-var">setDecodedStringJpg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165339"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165341"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165340"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165339"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; BoolReader s Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679165338"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span id="local-6989586621679165337"><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextIntJpg"><span class="hs-identifier hs-type">getNextIntJpg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165337"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span></span><span>
</span><span id="line-113"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextIntJpg"><span class="hs-pragma hs-type">getNextIntJpg</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-114"></span><span id="getNextIntJpg"><span class="annot"><span class="annottext">getNextIntJpg :: Int -&gt; BoolReader s Int32
</span><a href="Codec.Picture.BitWriter.html#getNextIntJpg"><span class="hs-identifier hs-var hs-var">getNextIntJpg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; BoolReader s Int32
forall a s.
(Bits a, Num a) =&gt;
a -&gt; Int -&gt; StateT BoolState (ST s) a
</span><a href="#local-6989586621679165336"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-115"></span><span>  </span><span id="local-6989586621679165336"><span class="annot"><span class="annottext">go :: a -&gt; Int -&gt; StateT BoolState (ST s) a
</span><a href="#local-6989586621679165336"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165335"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165335"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; StateT BoolState (ST s) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165335"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="#local-6989586621679165336"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165334"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165334"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165333"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165333"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span id="local-6989586621679165332"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165332"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621679165331"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165331"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679165330"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165330"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT BoolState (ST s) BoolState
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">S.get</span></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165329"><span class="annot"><span class="annottext">leftBits :: Int
</span><a href="#local-6989586621679165329"><span class="hs-identifier hs-var hs-var">leftBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165332"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165333"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165329"><span class="hs-identifier hs-var">leftBits</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="annottext">ByteString -&gt; BoolReader s ()
forall s. ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier hs-var">setDecodedStringJpg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165330"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165327"><span class="annot"><span class="annottext">remaining :: Int
</span><a href="#local-6989586621679165327"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165333"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165329"><span class="hs-identifier hs-var">leftBits</span></a></span><span>
</span><span id="line-122"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679165326"><span class="annot"><span class="annottext">mask :: a
</span><a href="#local-6989586621679165326"><span class="hs-identifier hs-var hs-var">mask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165329"><span class="hs-identifier hs-var">leftBits</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-123"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679165325"><span class="annot"><span class="annottext">finalV :: a
</span><a href="#local-6989586621679165325"><span class="hs-identifier hs-var hs-var">finalV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165331"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165326"><span class="hs-identifier hs-var">mask</span></a></span><span>
</span><span id="line-124"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679165324"><span class="annot"><span class="annottext">theseBits :: a
</span><a href="#local-6989586621679165324"><span class="hs-identifier hs-var hs-var">theseBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165325"><span class="hs-identifier hs-var">finalV</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165327"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; StateT BoolState (ST s) a
</span><a href="#local-6989586621679165336"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165334"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165324"><span class="hs-identifier hs-var">theseBits</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165327"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165323"><span class="annot"><span class="annottext">remaining :: Int
</span><a href="#local-6989586621679165323"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165329"><span class="hs-identifier hs-var">leftBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165333"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-128"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679165322"><span class="annot"><span class="annottext">mask :: a
</span><a href="#local-6989586621679165322"><span class="hs-identifier hs-var hs-var">mask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165333"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-129"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679165321"><span class="annot"><span class="annottext">finalV :: a
</span><a href="#local-6989586621679165321"><span class="hs-identifier hs-var hs-var">finalV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165331"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftR`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165323"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-130"></span><span>      </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165323"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165331"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165330"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="annottext">a -&gt; StateT BoolState (ST s) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; StateT BoolState (ST s) a) -&gt; a -&gt; StateT BoolState (ST s) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165321"><span class="hs-identifier hs-var">finalV</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165322"><span class="hs-identifier hs-var">mask</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679165334"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span id="local-6989586621679165320"><span class="annot"><a href="Codec.Picture.BitWriter.html#setDecodedStringMSB"><span class="hs-identifier hs-type">setDecodedStringMSB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165320"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-135"></span><span id="setDecodedStringMSB"><span class="annot"><span class="annottext">setDecodedStringMSB :: ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringMSB"><span class="hs-identifier hs-var hs-var">setDecodedStringMSB</span></a></span></span><span> </span><span id="local-6989586621679165319"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165319"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165319"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679165318"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165318"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165317"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165317"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165318"><span class="hs-identifier hs-var">v</span></a></span><span>    </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165317"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitsMSBFirst"><span class="hs-pragma hs-type">getNextBitsMSBFirst</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-141"></span><span id="local-6989586621679165316"><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitsMSBFirst"><span class="hs-identifier hs-type">getNextBitsMSBFirst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165316"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span></span><span>
</span><span id="line-142"></span><span id="getNextBitsMSBFirst"><span class="annot"><span class="annottext">getNextBitsMSBFirst :: Int -&gt; BoolReader s Word32
</span><a href="Codec.Picture.BitWriter.html#getNextBitsMSBFirst"><span class="hs-identifier hs-var hs-var">getNextBitsMSBFirst</span></a></span></span><span> </span><span id="local-6989586621679165315"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165315"><span class="hs-identifier hs-var">requested</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; BoolReader s Word32
forall s. Word32 -&gt; Int -&gt; BoolReader s Word32
</span><a href="#local-6989586621679165314"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165315"><span class="hs-identifier hs-var">requested</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-143"></span><span>  </span><span id="local-6989586621679165466"><span class="annot"><a href="#local-6989586621679165314"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165466"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span></span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621679165314"><span class="annot"><span class="annottext">go :: Word32 -&gt; Int -&gt; BoolReader s Word32
</span><a href="#local-6989586621679165314"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165313"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165313"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; BoolReader s Word32
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165313"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><a href="#local-6989586621679165314"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165312"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165312"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165311"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165311"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span id="local-6989586621679165310"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165310"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621679165309"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165309"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679165308"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165308"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT BoolState (ST s) BoolState
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">S.get</span></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165307"><span class="annot"><span class="annottext">leftBits :: Int
</span><a href="#local-6989586621679165307"><span class="hs-identifier hs-var hs-var">leftBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165310"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165311"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165307"><span class="hs-identifier hs-var">leftBits</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">ByteString -&gt; BoolReader s ()
forall s. ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringMSB"><span class="hs-identifier hs-var">setDecodedStringMSB</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165308"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165306"><span class="annot"><span class="annottext">theseBits :: Word32
</span><a href="#local-6989586621679165306"><span class="hs-identifier hs-var hs-var">theseBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165309"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165311"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165307"><span class="hs-identifier hs-var">leftBits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; BoolReader s Word32
forall s. Word32 -&gt; Int -&gt; BoolReader s Word32
</span><a href="#local-6989586621679165314"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165312"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165306"><span class="hs-identifier hs-var">theseBits</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165311"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165307"><span class="hs-identifier hs-var">leftBits</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679165305"><span class="annot"><span class="annottext">remaining :: Int
</span><a href="#local-6989586621679165305"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165307"><span class="hs-identifier hs-var">leftBits</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165311"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-154"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621679165304"><span class="annot"><span class="annottext">mask :: Word8
</span><a href="#local-6989586621679165304"><span class="hs-identifier hs-var hs-var">mask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165305"><span class="hs-identifier hs-var">remaining</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">1</span></span><span>
</span><span id="line-155"></span><span>      </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165305"><span class="hs-identifier hs-var">remaining</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165309"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165304"><span class="hs-identifier hs-var">mask</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165308"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">Word32 -&gt; BoolReader s Word32
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; BoolReader s Word32) -&gt; Word32 -&gt; BoolReader s Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165309"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftR`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165305"><span class="hs-identifier hs-var">remaining</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165312"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitsLSBFirst"><span class="hs-pragma hs-type">getNextBitsLSBFirst</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-159"></span><span id="local-6989586621679165303"><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBitsLSBFirst"><span class="hs-identifier hs-type">getNextBitsLSBFirst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165303"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span></span><span>
</span><span id="line-160"></span><span id="getNextBitsLSBFirst"><span class="annot"><span class="annottext">getNextBitsLSBFirst :: Int -&gt; BoolReader s Word32
</span><a href="Codec.Picture.BitWriter.html#getNextBitsLSBFirst"><span class="hs-identifier hs-var hs-var">getNextBitsLSBFirst</span></a></span></span><span> </span><span id="local-6989586621679165302"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165302"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; BoolReader s Word32
forall a s.
(Bits a, Num a) =&gt;
a -&gt; Int -&gt; StateT BoolState (ST s) a
</span><a href="#local-6989586621679165301"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165302"><span class="hs-identifier hs-var">count</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679165301"><span class="annot"><span class="annottext">aux :: t -&gt; Int -&gt; StateT BoolState (ST s) t
</span><a href="#local-6989586621679165301"><span class="hs-identifier hs-var hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621679165300"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679165300"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; StateT BoolState (ST s) t
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679165300"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><a href="#local-6989586621679165301"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span id="local-6989586621679165299"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679165299"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679165298"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165298"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>            </span><span id="local-6989586621679165297"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679165297"><span class="hs-identifier hs-var">bit</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BoolReader s Bool
forall s. BoolReader s Bool
</span><a href="Codec.Picture.BitWriter.html#getNextBit"><span class="hs-identifier hs-var">getNextBit</span></a></span><span>
</span><span id="line-164"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165295"><span class="annot"><span class="annottext">nextVal :: t
</span><a href="#local-6989586621679165295"><span class="hs-identifier hs-var hs-var">nextVal</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679165297"><span class="hs-identifier hs-var">bit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679165299"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; Int -&gt; t
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165302"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165298"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679165299"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-166"></span><span>            </span><span class="annot"><span class="annottext">t -&gt; Int -&gt; StateT BoolState (ST s) t
</span><a href="#local-6989586621679165301"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679165295"><span class="hs-identifier hs-var">nextVal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165298"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBit"><span class="hs-pragma hs-type">getNextBit</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-169"></span><span id="local-6989586621679165461"><span class="annot"><a href="Codec.Picture.BitWriter.html#getNextBit"><span class="hs-identifier hs-type">getNextBit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165461"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-170"></span><span id="getNextBit"><span class="annot"><span class="annottext">getNextBit :: BoolReader s Bool
</span><a href="Codec.Picture.BitWriter.html#getNextBit"><span class="hs-identifier hs-var hs-var">getNextBit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-type">BoolState</span></a></span><span> </span><span id="local-6989586621679165294"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165294"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621679165293"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165293"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679165292"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165292"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT BoolState (ST s) BoolState
forall (m :: * -&gt; *) s. Monad m =&gt; StateT s m s
</span><span class="hs-identifier hs-var">S.get</span></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165291"><span class="annot"><span class="annottext">val :: Bool
</span><a href="#local-6989586621679165291"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165293"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165294"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165294"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BoolReader s ()
forall s. ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedString"><span class="hs-identifier hs-var">setDecodedString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165292"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165294"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165293"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165292"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; BoolReader s Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679165291"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | Bitify a list of things to decode. Handle Jpeg escape</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- code (0xFF 0x00), thus should be only used in JPEG decoding.</span><span>
</span><span id="line-180"></span><span id="local-6989586621679165481"><span class="annot"><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier hs-type">setDecodedStringJpg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolReader"><span class="hs-identifier hs-type">BoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165481"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-181"></span><span id="setDecodedStringJpg"><span class="annot"><span class="annottext">setDecodedStringJpg :: ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier hs-var hs-var">setDecodedStringJpg</span></a></span></span><span> </span><span id="local-6989586621679165290"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165290"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165290"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-182"></span><span>     </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-183"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xFF</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165289"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165289"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165289"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-184"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-185"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x00</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165288"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165288"><span class="hs-identifier hs-var">afterMarker</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- trace &quot;00&quot; $ </span><span>
</span><span id="line-186"></span><span>                </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xFF</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165288"><span class="hs-identifier hs-var">afterMarker</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165287"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165287"><span class="hs-identifier hs-var">afterMarker</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BoolReader s ()
forall s. ByteString -&gt; BoolReader s ()
</span><a href="Codec.Picture.BitWriter.html#setDecodedStringJpg"><span class="hs-identifier hs-var">setDecodedStringJpg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165287"><span class="hs-identifier hs-var">afterMarker</span></a></span><span>
</span><span id="line-188"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679165286"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165286"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679165285"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165285"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">BoolState -&gt; BoolReader s ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><span class="hs-identifier hs-var">S.put</span></span><span> </span><span class="annot"><span class="annottext">(BoolState -&gt; BoolReader s ()) -&gt; BoolState -&gt; BoolReader s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString -&gt; BoolState
</span><a href="Codec.Picture.BitWriter.html#BoolState"><span class="hs-identifier hs-var">BoolState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165286"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165285"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-192"></span><span class="hs-comment">----            Writer</span><span>
</span><span id="line-193"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-194"></span><span class="annot"><a href="Codec.Picture.BitWriter.html#defaultBufferSize"><span class="hs-identifier hs-type">defaultBufferSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-195"></span><span id="defaultBufferSize"><span class="annot"><span class="annottext">defaultBufferSize :: Int
</span><a href="Codec.Picture.BitWriter.html#defaultBufferSize"><span class="hs-identifier hs-var hs-var">defaultBufferSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">256</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-keyword">data</span><span> </span><span id="BoolWriteStateRef"><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-var">BoolWriteStateRef</span></a></span></span><span> </span><span id="local-6989586621679165444"><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BoolWriteStateRef"><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-var">BoolWriteStateRef</span></a></span></span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="bwsCurrBuffer"><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s (MVector s Word8)
</span><a href="Codec.Picture.BitWriter.html#bwsCurrBuffer"><span class="hs-identifier hs-var hs-var">bwsCurrBuffer</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STRef</span></span><span> </span><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">M.MVector</span></span><span> </span><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="bwsBufferList"><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s [ByteString]
</span><a href="Codec.Picture.BitWriter.html#bwsBufferList"><span class="hs-identifier hs-var hs-var">bwsBufferList</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STRef</span></span><span> </span><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">]</span><span>
</span><span id="line-200"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="bwsWrittenWords"><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsWrittenWords"><span class="hs-identifier hs-var hs-var">bwsWrittenWords</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STRef</span></span><span> </span><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-201"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="bwsBitAcc"><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Word8
</span><a href="Codec.Picture.BitWriter.html#bwsBitAcc"><span class="hs-identifier hs-var hs-var">bwsBitAcc</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STRef</span></span><span> </span><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="bwsBitReaded"><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsBitReaded"><span class="hs-identifier hs-var hs-var">bwsBitReaded</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STRef</span></span><span> </span><span class="annot"><a href="#local-6989586621679165444"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621679165276"><span class="annot"><a href="Codec.Picture.BitWriter.html#newWriteStateRef"><span class="hs-identifier hs-type">newWriteStateRef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165276"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165276"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-206"></span><span id="newWriteStateRef"><span class="annot"><span class="annottext">newWriteStateRef :: ST s (BoolWriteStateRef s)
</span><a href="Codec.Picture.BitWriter.html#newWriteStateRef"><span class="hs-identifier hs-var hs-var">newWriteStateRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621679165275"><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165275"><span class="hs-identifier hs-var">origMv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MVector (PrimState (ST s)) Word8)
forall (m :: * -&gt; *) a.
(PrimMonad m, Storable a) =&gt;
Int -&gt; m (MVector (PrimState m) a)
</span><span class="hs-identifier hs-var">M.new</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Codec.Picture.BitWriter.html#defaultBufferSize"><span class="hs-identifier hs-var">defaultBufferSize</span></a></span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><span class="annottext">STRef s (MVector s Word8)
-&gt; STRef s [ByteString]
-&gt; STRef s Int
-&gt; STRef s Word8
-&gt; STRef s Int
-&gt; BoolWriteStateRef s
forall s.
STRef s (MVector s Word8)
-&gt; STRef s [ByteString]
-&gt; STRef s Int
-&gt; STRef s Word8
-&gt; STRef s Int
-&gt; BoolWriteStateRef s
</span><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-var">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">(STRef s (MVector s Word8)
 -&gt; STRef s [ByteString]
 -&gt; STRef s Int
 -&gt; STRef s Word8
 -&gt; STRef s Int
 -&gt; BoolWriteStateRef s)
-&gt; ST s (STRef s (MVector s Word8))
-&gt; ST
     s
     (STRef s [ByteString]
      -&gt; STRef s Int
      -&gt; STRef s Word8
      -&gt; STRef s Int
      -&gt; BoolWriteStateRef s)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">MVector s Word8 -&gt; ST s (STRef s (MVector s Word8))
forall a s. a -&gt; ST s (STRef s a)
</span><span class="hs-identifier hs-var">newSTRef</span></span><span> </span><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165275"><span class="hs-identifier hs-var">origMv</span></a></span><span>
</span><span id="line-209"></span><span>                      </span><span class="annot"><span class="annottext">ST
  s
  (STRef s [ByteString]
   -&gt; STRef s Int
   -&gt; STRef s Word8
   -&gt; STRef s Int
   -&gt; BoolWriteStateRef s)
-&gt; ST s (STRef s [ByteString])
-&gt; ST
     s
     (STRef s Int
      -&gt; STRef s Word8 -&gt; STRef s Int -&gt; BoolWriteStateRef s)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ST s (STRef s [ByteString])
forall a s. a -&gt; ST s (STRef s a)
</span><span class="hs-identifier hs-var">newSTRef</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-210"></span><span>                      </span><span class="annot"><span class="annottext">ST
  s
  (STRef s Int
   -&gt; STRef s Word8 -&gt; STRef s Int -&gt; BoolWriteStateRef s)
-&gt; ST s (STRef s Int)
-&gt; ST s (STRef s Word8 -&gt; STRef s Int -&gt; BoolWriteStateRef s)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (STRef s Int)
forall a s. a -&gt; ST s (STRef s a)
</span><span class="hs-identifier hs-var">newSTRef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-211"></span><span>                      </span><span class="annot"><span class="annottext">ST s (STRef s Word8 -&gt; STRef s Int -&gt; BoolWriteStateRef s)
-&gt; ST s (STRef s Word8)
-&gt; ST s (STRef s Int -&gt; BoolWriteStateRef s)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; ST s (STRef s Word8)
forall a s. a -&gt; ST s (STRef s a)
</span><span class="hs-identifier hs-var">newSTRef</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span>
</span><span id="line-212"></span><span>                      </span><span class="annot"><span class="annottext">ST s (STRef s Int -&gt; BoolWriteStateRef s)
-&gt; ST s (STRef s Int) -&gt; ST s (BoolWriteStateRef s)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (STRef s Int)
forall a s. a -&gt; ST s (STRef s a)
</span><span class="hs-identifier hs-var">newSTRef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span id="local-6989586621679165271"><span class="annot"><a href="Codec.Picture.BitWriter.html#finalizeBoolWriter"><span class="hs-identifier hs-type">finalizeBoolWriter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165271"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165271"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.ByteString</span></span></span><span>
</span><span id="line-215"></span><span id="finalizeBoolWriter"><span class="annot"><span class="annottext">finalizeBoolWriter :: BoolWriteStateRef s -&gt; ST s ByteString
</span><a href="Codec.Picture.BitWriter.html#finalizeBoolWriter"><span class="hs-identifier hs-var hs-var">finalizeBoolWriter</span></a></span></span><span> </span><span id="local-6989586621679165270"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165270"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#flushLeftBits%27"><span class="hs-identifier hs-var">flushLeftBits'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165270"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#forceBufferFlushing%27"><span class="hs-identifier hs-var">forceBufferFlushing'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165270"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">L.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString)
-&gt; ST s [ByteString] -&gt; ST s ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STRef s [ByteString] -&gt; ST s [ByteString]
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s [ByteString]
forall s. BoolWriteStateRef s -&gt; STRef s [ByteString]
</span><a href="Codec.Picture.BitWriter.html#bwsBufferList"><span class="hs-identifier hs-var hs-var">bwsBufferList</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165270"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span id="local-6989586621679165265"><span class="annot"><a href="Codec.Picture.BitWriter.html#forceBufferFlushing%27"><span class="hs-identifier hs-type">forceBufferFlushing'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165265"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165265"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-221"></span><span id="forceBufferFlushing%27"><span class="annot"><span class="annottext">forceBufferFlushing' :: BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#forceBufferFlushing%27"><span class="hs-identifier hs-var hs-var">forceBufferFlushing'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">bwsCurrBuffer :: forall s. BoolWriteStateRef s -&gt; STRef s (MVector s Word8)
</span><a href="Codec.Picture.BitWriter.html#bwsCurrBuffer"><span class="hs-identifier hs-var">bwsCurrBuffer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679165264"><span class="annot"><span class="annottext">STRef s (MVector s Word8)
</span><a href="#local-6989586621679165264"><span class="hs-identifier hs-var">vecRef</span></a></span></span><span>
</span><span id="line-222"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bwsWrittenWords :: forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsWrittenWords"><span class="hs-identifier hs-var">bwsWrittenWords</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679165263"><span class="annot"><span class="annottext">STRef s Int
</span><a href="#local-6989586621679165263"><span class="hs-identifier hs-var">countRef</span></a></span></span><span>
</span><span id="line-223"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bwsBufferList :: forall s. BoolWriteStateRef s -&gt; STRef s [ByteString]
</span><a href="Codec.Picture.BitWriter.html#bwsBufferList"><span class="hs-identifier hs-var">bwsBufferList</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679165262"><span class="annot"><span class="annottext">STRef s [ByteString]
</span><a href="#local-6989586621679165262"><span class="hs-identifier hs-var">lstRef</span></a></span></span><span>
</span><span id="line-224"></span><span>                                        </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621679165261"><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165261"><span class="hs-identifier hs-var">vec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s (MVector s Word8) -&gt; ST s (MVector s Word8)
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s (MVector s Word8)
</span><a href="#local-6989586621679165264"><span class="hs-identifier hs-var">vecRef</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621679165260"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165260"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s Int
</span><a href="#local-6989586621679165263"><span class="hs-identifier hs-var">countRef</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621679165259"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679165259"><span class="hs-identifier hs-var">lst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s [ByteString] -&gt; ST s [ByteString]
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s [ByteString]
</span><a href="#local-6989586621679165262"><span class="hs-identifier hs-var">lstRef</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621679165258"><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165258"><span class="hs-identifier hs-var">nmv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MVector (PrimState (ST s)) Word8)
forall (m :: * -&gt; *) a.
(PrimMonad m, Storable a) =&gt;
Int -&gt; m (MVector (PrimState m) a)
</span><span class="hs-identifier hs-var">M.new</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Codec.Picture.BitWriter.html#defaultBufferSize"><span class="hs-identifier hs-var">defaultBufferSize</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621679165257"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165257"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVector s Word8 -&gt; Int -&gt; ST s ByteString
forall s. MVector s Word8 -&gt; Int -&gt; ST s ByteString
</span><a href="Codec.Picture.BitWriter.html#byteStringFromVector"><span class="hs-identifier hs-var">byteStringFromVector</span></a></span><span> </span><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165261"><span class="hs-identifier hs-var">vec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165260"><span class="hs-identifier hs-var">count</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><span class="annottext">STRef s (MVector s Word8) -&gt; MVector s Word8 -&gt; ST s ()
forall s a. STRef s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">writeSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s (MVector s Word8)
</span><a href="#local-6989586621679165264"><span class="hs-identifier hs-var">vecRef</span></a></span><span> </span><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165258"><span class="hs-identifier hs-var">nmv</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="annottext">STRef s [ByteString] -&gt; [ByteString] -&gt; ST s ()
forall s a. STRef s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">writeSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s [ByteString]
</span><a href="#local-6989586621679165262"><span class="hs-identifier hs-var">lstRef</span></a></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ST s ()) -&gt; [ByteString] -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679165259"><span class="hs-identifier hs-var">lst</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679165257"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">STRef s Int -&gt; Int -&gt; ST s ()
forall s a. STRef s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">writeSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s Int
</span><a href="#local-6989586621679165263"><span class="hs-identifier hs-var">countRef</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span id="local-6989586621679165254"><span class="annot"><a href="Codec.Picture.BitWriter.html#flushCurrentBuffer%27"><span class="hs-identifier hs-type">flushCurrentBuffer'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165254"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165254"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-237"></span><span id="flushCurrentBuffer%27"><span class="annot"><span class="annottext">flushCurrentBuffer' :: BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#flushCurrentBuffer%27"><span class="hs-identifier hs-var hs-var">flushCurrentBuffer'</span></a></span></span><span> </span><span id="local-6989586621679165252"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165252"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621679165251"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165251"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Int -&gt; ST s Int) -&gt; STRef s Int -&gt; ST s Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsWrittenWords"><span class="hs-identifier hs-var hs-var">bwsWrittenWords</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165252"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ST s () -&gt; ST s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165251"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Codec.Picture.BitWriter.html#defaultBufferSize"><span class="hs-identifier hs-var">defaultBufferSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#forceBufferFlushing%27"><span class="hs-identifier hs-var">forceBufferFlushing'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165252"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span id="local-6989586621679165428"><span class="annot"><a href="Codec.Picture.BitWriter.html#byteStringFromVector"><span class="hs-identifier hs-type">byteStringFromVector</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.MVector</span></span><span> </span><span class="annot"><a href="#local-6989586621679165428"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165428"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span></span><span>
</span><span id="line-243"></span><span id="byteStringFromVector"><span class="annot"><span class="annottext">byteStringFromVector :: MVector s Word8 -&gt; Int -&gt; ST s ByteString
</span><a href="Codec.Picture.BitWriter.html#byteStringFromVector"><span class="hs-identifier hs-var hs-var">byteStringFromVector</span></a></span></span><span> </span><span id="local-6989586621679165250"><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165250"><span class="hs-identifier hs-var">vec</span></a></span></span><span> </span><span id="local-6989586621679165249"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165249"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621679165248"><span class="annot"><span class="annottext">Vector Word8
</span><a href="#local-6989586621679165248"><span class="hs-identifier hs-var">frozen</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (ST s)) Word8 -&gt; ST s (Vector Word8)
forall a (m :: * -&gt; *).
(Storable a, PrimMonad m) =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><span class="hs-identifier hs-var">VS.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MVector s Word8
MVector (PrimState (ST s)) Word8
</span><a href="#local-6989586621679165250"><span class="hs-identifier hs-var">vec</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">ByteString -&gt; ST s ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ST s ByteString) -&gt; ByteString -&gt; ST s ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Vector Word8 -&gt; Int -&gt; Int -&gt; ByteString
</span><a href="Codec.Picture.VectorByteConversion.html#blitVector"><span class="hs-identifier hs-var">blitVector</span></a></span><span> </span><span class="annot"><span class="annottext">Vector Word8
</span><a href="#local-6989586621679165248"><span class="hs-identifier hs-var">frozen</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165249"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span id="local-6989586621679165417"><span class="annot"><a href="Codec.Picture.BitWriter.html#setBitCount%27"><span class="hs-identifier hs-type">setBitCount'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165417"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165417"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-248"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#setBitCount%27"><span class="hs-pragma hs-type">setBitCount'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-249"></span><span id="setBitCount%27"><span class="annot"><span class="annottext">setBitCount' :: BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#setBitCount%27"><span class="hs-identifier hs-var hs-var">setBitCount'</span></a></span></span><span> </span><span id="local-6989586621679165245"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165245"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679165244"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165244"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679165243"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165243"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">STRef s Word8 -&gt; Word8 -&gt; ST s ()
forall s a. STRef s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">writeSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Word8
forall s. BoolWriteStateRef s -&gt; STRef s Word8
</span><a href="Codec.Picture.BitWriter.html#bwsBitAcc"><span class="hs-identifier hs-var hs-var">bwsBitAcc</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165245"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165244"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="annot"><span class="annottext">STRef s Int -&gt; Int -&gt; ST s ()
forall s a. STRef s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">writeSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsBitReaded"><span class="hs-identifier hs-var hs-var">bwsBitReaded</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165245"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165243"><span class="hs-identifier hs-var">count</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span id="local-6989586621679165242"><span class="annot"><a href="Codec.Picture.BitWriter.html#resetBitCount%27"><span class="hs-identifier hs-type">resetBitCount'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165242"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165242"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-254"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#resetBitCount%27"><span class="hs-pragma hs-type">resetBitCount'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-255"></span><span id="resetBitCount%27"><span class="annot"><span class="annottext">resetBitCount' :: BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#resetBitCount%27"><span class="hs-identifier hs-var hs-var">resetBitCount'</span></a></span></span><span> </span><span id="local-6989586621679165240"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165240"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#setBitCount%27"><span class="hs-identifier hs-var">setBitCount'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165240"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span id="local-6989586621679165412"><span class="annot"><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-type">pushByte'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165412"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165412"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-258"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-pragma hs-type">pushByte'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-259"></span><span id="pushByte%27"><span class="annot"><span class="annottext">pushByte' :: BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var hs-var">pushByte'</span></a></span></span><span> </span><span id="local-6989586621679165238"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165238"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679165237"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165237"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#flushCurrentBuffer%27"><span class="hs-identifier hs-var">flushCurrentBuffer'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165238"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621679165236"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165236"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsWrittenWords"><span class="hs-identifier hs-var hs-var">bwsWrittenWords</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165238"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621679165235"><span class="annot"><span class="annottext">MVector s Word8
</span><a href="#local-6989586621679165235"><span class="hs-identifier hs-var">vec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s (MVector s Word8) -&gt; ST s (MVector s Word8)
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s (MVector s Word8)
forall s. BoolWriteStateRef s -&gt; STRef s (MVector s Word8)
</span><a href="Codec.Picture.BitWriter.html#bwsCurrBuffer"><span class="hs-identifier hs-var hs-var">bwsCurrBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165238"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="annottext">MVector (PrimState (ST s)) Word8 -&gt; Int -&gt; Word8 -&gt; ST s ()
forall (m :: * -&gt; *) a.
(PrimMonad m, Storable a) =&gt;
MVector (PrimState m) a -&gt; Int -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">M.write</span></span><span> </span><span class="annot"><span class="annottext">MVector s Word8
MVector (PrimState (ST s)) Word8
</span><a href="#local-6989586621679165235"><span class="hs-identifier hs-var">vec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165236"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165237"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">STRef s Int -&gt; Int -&gt; ST s ()
forall s a. STRef s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">writeSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsWrittenWords"><span class="hs-identifier hs-var hs-var">bwsWrittenWords</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165238"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ST s ()) -&gt; Int -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165236"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span id="local-6989586621679165432"><span class="annot"><a href="Codec.Picture.BitWriter.html#flushLeftBits%27"><span class="hs-identifier hs-type">flushLeftBits'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165432"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165432"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-267"></span><span id="flushLeftBits%27"><span class="annot"><span class="annottext">flushLeftBits' :: BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#flushLeftBits%27"><span class="hs-identifier hs-var hs-var">flushLeftBits'</span></a></span></span><span> </span><span id="local-6989586621679165233"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165233"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621679165232"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165232"><span class="hs-identifier hs-var">currCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Int -&gt; ST s Int) -&gt; STRef s Int -&gt; ST s Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsBitReaded"><span class="hs-identifier hs-var hs-var">bwsBitReaded</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165233"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ST s () -&gt; ST s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165232"><span class="hs-identifier hs-var">currCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ST s () -&gt; ST s ()) -&gt; ST s () -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>      </span><span id="local-6989586621679165230"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165230"><span class="hs-identifier hs-var">currWord</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Word8 -&gt; ST s Word8
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Word8 -&gt; ST s Word8) -&gt; STRef s Word8 -&gt; ST s Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Word8
forall s. BoolWriteStateRef s -&gt; STRef s Word8
</span><a href="Codec.Picture.BitWriter.html#bwsBitAcc"><span class="hs-identifier hs-var hs-var">bwsBitAcc</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165233"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var">pushByte'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165233"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; ST s ()) -&gt; Word8 -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165230"><span class="hs-identifier hs-var">currWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165232"><span class="hs-identifier hs-var">currCount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- | Append some data bits to a Put monad.</span><span>
</span><span id="line-274"></span><span id="local-6989586621679165229"><span class="annot"><a href="Codec.Picture.BitWriter.html#writeBits%27"><span class="hs-identifier hs-type">writeBits'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165229"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-275"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>     </span><span class="hs-comment">-- ^ The real data to be stored. Actual data should be in the LSB</span><span>
</span><span id="line-276"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>        </span><span class="hs-comment">-- ^ Number of bit to write from 1 to 32</span><span>
</span><span id="line-277"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165229"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-278"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#writeBits%27"><span class="hs-pragma hs-type">writeBits'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-279"></span><span id="writeBits%27"><span class="annot"><span class="annottext">writeBits' :: BoolWriteStateRef s -&gt; Word32 -&gt; Int -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#writeBits%27"><span class="hs-identifier hs-var hs-var">writeBits'</span></a></span></span><span> </span><span id="local-6989586621679165228"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679165227"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165227"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679165226"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165226"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621679165225"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165225"><span class="hs-identifier hs-var">currWord</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Word8 -&gt; ST s Word8
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Word8 -&gt; ST s Word8) -&gt; STRef s Word8 -&gt; ST s Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Word8
forall s. BoolWriteStateRef s -&gt; STRef s Word8
</span><a href="Codec.Picture.BitWriter.html#bwsBitAcc"><span class="hs-identifier hs-var hs-var">bwsBitAcc</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621679165224"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165224"><span class="hs-identifier hs-var">currCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Int -&gt; ST s Int) -&gt; STRef s Int -&gt; ST s Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsBitReaded"><span class="hs-identifier hs-var hs-var">bwsBitReaded</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679165223"><span class="hs-identifier hs-var">serialize</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165227"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165226"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165225"><span class="hs-identifier hs-var">currWord</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165224"><span class="hs-identifier hs-var">currCount</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679165222"><span class="annot"><span class="annottext">dumpByte :: Word8 -&gt; ST s ()
</span><a href="#local-6989586621679165222"><span class="hs-identifier hs-var hs-var">dumpByte</span></a></span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xFF</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var">pushByte'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xFF</span></span><span> </span><span class="annot"><span class="annottext">ST s () -&gt; ST s () -&gt; ST s ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var">pushByte'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x00</span></span><span>
</span><span id="line-284"></span><span>        </span><span class="annot"><a href="#local-6989586621679165222"><span class="hs-identifier hs-var">dumpByte</span></a></span><span>    </span><span id="local-6989586621679165221"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165221"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var">pushByte'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165221"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621679165223"><span class="annot"><span class="annottext">serialize :: Word32 -&gt; Int -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679165223"><span class="hs-identifier hs-var hs-var">serialize</span></a></span></span><span> </span><span id="local-6989586621679165220"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165220"><span class="hs-identifier hs-var">bitData</span></a></span></span><span> </span><span id="local-6989586621679165219"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span></span><span> </span><span id="local-6989586621679165218"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165218"><span class="hs-identifier hs-var">currentWord</span></a></span></span><span> </span><span id="local-6989586621679165217"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165217"><span class="hs-identifier hs-var">count</span></a></span></span><span>
</span><span id="line-287"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165217"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>                     </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#resetBitCount%27"><span class="hs-identifier hs-var">resetBitCount'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-289"></span><span>                     </span><span class="annot"><span class="annottext">Word8 -&gt; ST s ()
</span><a href="#local-6989586621679165222"><span class="hs-identifier hs-var">dumpByte</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Word8) -&gt; Word8 -&gt; Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165218"><span class="hs-identifier hs-var">currentWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span>
</span><span id="line-290"></span><span>                                                </span><span class="annot"><span class="annottext">Word32 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165216"><span class="hs-identifier hs-var">cleanData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165217"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165214"><span class="annot"><span class="annottext">newVal :: Word8
</span><a href="#local-6989586621679165214"><span class="hs-identifier hs-var hs-var">newVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165218"><span class="hs-identifier hs-var">currentWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span>
</span><span id="line-294"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#setBitCount%27"><span class="hs-identifier hs-var">setBitCount'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165228"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165214"><span class="hs-identifier hs-var">newVal</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165216"><span class="hs-identifier hs-var">cleanData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ST s ()) -&gt; Int -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165217"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-297"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165213"><span class="annot"><span class="annottext">leftBitCount :: Int
</span><a href="#local-6989586621679165213"><span class="hs-identifier hs-var hs-var">leftBitCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165217"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-298"></span><span>                    </span><span id="local-6989586621679165212"><span class="annot"><span class="annottext">highPart :: Word32
</span><a href="#local-6989586621679165212"><span class="hs-identifier hs-var hs-var">highPart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165216"><span class="hs-identifier hs-var">cleanData</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftR`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165213"><span class="hs-identifier hs-var">leftBitCount</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-299"></span><span>                    </span><span id="local-6989586621679165211"><span class="annot"><span class="annottext">prevPart :: Word32
</span><a href="#local-6989586621679165211"><span class="hs-identifier hs-var hs-var">prevPart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165218"><span class="hs-identifier hs-var">currentWord</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165213"><span class="hs-identifier hs-var">leftBitCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span>                    </span><span id="local-6989586621679165210"><span class="annot"><span class="annottext">nextMask :: Word32
</span><a href="#local-6989586621679165210"><span class="hs-identifier hs-var hs-var">nextMask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165213"><span class="hs-identifier hs-var">leftBitCount</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-302"></span><span>                    </span><span id="local-6989586621679165209"><span class="annot"><span class="annottext">newData :: Word32
</span><a href="#local-6989586621679165209"><span class="hs-identifier hs-var hs-var">newData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165216"><span class="hs-identifier hs-var">cleanData</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165210"><span class="hs-identifier hs-var">nextMask</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-303"></span><span>                    </span><span id="local-6989586621679165208"><span class="annot"><span class="annottext">newCount :: Int
</span><a href="#local-6989586621679165208"><span class="hs-identifier hs-var hs-var">newCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165213"><span class="hs-identifier hs-var">leftBitCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>                    </span><span id="local-6989586621679165207"><span class="annot"><span class="annottext">toWrite :: Word8
</span><a href="#local-6989586621679165207"><span class="hs-identifier hs-var hs-var">toWrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Word8) -&gt; Word32 -&gt; Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165211"><span class="hs-identifier hs-var">prevPart</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165212"><span class="hs-identifier hs-var">highPart</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-306"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; ST s ()
</span><a href="#local-6989586621679165222"><span class="hs-identifier hs-var">dumpByte</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165207"><span class="hs-identifier hs-var">toWrite</span></a></span><span> </span><span class="annot"><span class="annottext">ST s () -&gt; ST s () -&gt; ST s ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679165223"><span class="hs-identifier hs-var">serialize</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165209"><span class="hs-identifier hs-var">newData</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165208"><span class="hs-identifier hs-var">newCount</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>              </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679165206"><span class="annot"><span class="annottext">cleanMask :: Word32
</span><a href="#local-6989586621679165206"><span class="hs-identifier hs-var hs-var">cleanMask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165219"><span class="hs-identifier hs-var">bitCount</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-309"></span><span>                    </span><span id="local-6989586621679165216"><span class="annot"><span class="annottext">cleanData :: Word32
</span><a href="#local-6989586621679165216"><span class="hs-identifier hs-var hs-var">cleanData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165220"><span class="hs-identifier hs-var">bitData</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165206"><span class="hs-identifier hs-var">cleanMask</span></a></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">-- | Append some data bits to a Put monad.</span><span>
</span><span id="line-312"></span><span id="local-6989586621679165205"><span class="annot"><a href="Codec.Picture.BitWriter.html#writeBitsGif"><span class="hs-identifier hs-type">writeBitsGif</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165205"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-313"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>     </span><span class="hs-comment">-- ^ The real data to be stored. Actual data should be in the LSB</span><span>
</span><span id="line-314"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>        </span><span class="hs-comment">-- ^ Number of bit to write from 1 to 32</span><span>
</span><span id="line-315"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165205"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-316"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#writeBitsGif"><span class="hs-pragma hs-type">writeBitsGif</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-317"></span><span id="writeBitsGif"><span class="annot"><span class="annottext">writeBitsGif :: BoolWriteStateRef s -&gt; Word32 -&gt; Int -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#writeBitsGif"><span class="hs-identifier hs-var hs-var">writeBitsGif</span></a></span></span><span> </span><span id="local-6989586621679165204"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165204"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679165203"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165203"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679165202"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165202"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679165201"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165201"><span class="hs-identifier hs-var">currWord</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Word8 -&gt; ST s Word8
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Word8 -&gt; ST s Word8) -&gt; STRef s Word8 -&gt; ST s Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Word8
forall s. BoolWriteStateRef s -&gt; STRef s Word8
</span><a href="Codec.Picture.BitWriter.html#bwsBitAcc"><span class="hs-identifier hs-var hs-var">bwsBitAcc</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165204"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621679165200"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165200"><span class="hs-identifier hs-var">currCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Int -&gt; ST s Int) -&gt; STRef s Int -&gt; ST s Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsBitReaded"><span class="hs-identifier hs-var hs-var">bwsBitReaded</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165204"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679165199"><span class="hs-identifier hs-var">serialize</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165203"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165202"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165201"><span class="hs-identifier hs-var">currWord</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165200"><span class="hs-identifier hs-var">currCount</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679165198"><span class="annot"><span class="annottext">dumpByte :: Word8 -&gt; ST s ()
</span><a href="#local-6989586621679165198"><span class="hs-identifier hs-var hs-var">dumpByte</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var">pushByte'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165204"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>        </span><span id="local-6989586621679165199"><span class="annot"><span class="annottext">serialize :: Word32 -&gt; Int -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679165199"><span class="hs-identifier hs-var hs-var">serialize</span></a></span></span><span> </span><span id="local-6989586621679165197"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165197"><span class="hs-identifier hs-var">bitData</span></a></span></span><span> </span><span id="local-6989586621679165196"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165196"><span class="hs-identifier hs-var">bitCount</span></a></span></span><span> </span><span id="local-6989586621679165195"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165195"><span class="hs-identifier hs-var">currentWord</span></a></span></span><span> </span><span id="local-6989586621679165194"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span></span><span>
</span><span id="line-324"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165196"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>                     </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#resetBitCount%27"><span class="hs-identifier hs-var">resetBitCount'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165204"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-326"></span><span>                     </span><span class="annot"><span class="annottext">Word8 -&gt; ST s ()
</span><a href="#local-6989586621679165198"><span class="hs-identifier hs-var">dumpByte</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Word8) -&gt; Word8 -&gt; Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165195"><span class="hs-identifier hs-var">currentWord</span></a></span><span>  </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span>
</span><span id="line-327"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165193"><span class="hs-identifier hs-var">cleanData</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165196"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165192"><span class="annot"><span class="annottext">newVal :: Word8
</span><a href="#local-6989586621679165192"><span class="hs-identifier hs-var hs-var">newVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165193"><span class="hs-identifier hs-var">cleanData</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span>
</span><span id="line-331"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#setBitCount%27"><span class="hs-identifier hs-var">setBitCount'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165204"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165192"><span class="hs-identifier hs-var">newVal</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165195"><span class="hs-identifier hs-var">currentWord</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ST s ()) -&gt; Int -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165196"><span class="hs-identifier hs-var">bitCount</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-334"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679165191"><span class="annot"><span class="annottext">leftBitCount :: Int
</span><a href="#local-6989586621679165191"><span class="hs-identifier hs-var hs-var">leftBitCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-335"></span><span>                    </span><span id="local-6989586621679165190"><span class="annot"><span class="annottext">newData :: Word32
</span><a href="#local-6989586621679165190"><span class="hs-identifier hs-var hs-var">newData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165193"><span class="hs-identifier hs-var">cleanData</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftR`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165191"><span class="hs-identifier hs-var">leftBitCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-336"></span><span>                    </span><span id="local-6989586621679165189"><span class="annot"><span class="annottext">newCount :: Int
</span><a href="#local-6989586621679165189"><span class="hs-identifier hs-var hs-var">newCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165196"><span class="hs-identifier hs-var">bitCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165191"><span class="hs-identifier hs-var">leftBitCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-337"></span><span>                    </span><span id="local-6989586621679165188"><span class="annot"><span class="annottext">toWrite :: Word8
</span><a href="#local-6989586621679165188"><span class="hs-identifier hs-var hs-var">toWrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Word8) -&gt; Word32 -&gt; Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165195"><span class="hs-identifier hs-var">currentWord</span></a></span><span> </span><span>
</span><span id="line-338"></span><span>                                            </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165193"><span class="hs-identifier hs-var">cleanData</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165194"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-339"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; ST s ()
</span><a href="#local-6989586621679165198"><span class="hs-identifier hs-var">dumpByte</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165188"><span class="hs-identifier hs-var">toWrite</span></a></span><span> </span><span class="annot"><span class="annottext">ST s () -&gt; ST s () -&gt; ST s ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word8 -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679165199"><span class="hs-identifier hs-var">serialize</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165190"><span class="hs-identifier hs-var">newData</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165189"><span class="hs-identifier hs-var">newCount</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>              </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679165187"><span class="annot"><span class="annottext">cleanMask :: Word32
</span><a href="#local-6989586621679165187"><span class="hs-identifier hs-var hs-var">cleanMask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`unsafeShiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165196"><span class="hs-identifier hs-var">bitCount</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-342"></span><span>                    </span><span id="local-6989586621679165193"><span class="annot"><span class="annottext">cleanData :: Word32
</span><a href="#local-6989586621679165193"><span class="hs-identifier hs-var hs-var">cleanData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165197"><span class="hs-identifier hs-var">bitData</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679165187"><span class="hs-identifier hs-var">cleanMask</span></a></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span id="local-6989586621679165186"><span class="annot"><a href="Codec.Picture.BitWriter.html#finalizeBoolWriterGif"><span class="hs-identifier hs-type">finalizeBoolWriterGif</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165186"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165186"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.ByteString</span></span></span><span>
</span><span id="line-345"></span><span id="finalizeBoolWriterGif"><span class="annot"><span class="annottext">finalizeBoolWriterGif :: BoolWriteStateRef s -&gt; ST s ByteString
</span><a href="Codec.Picture.BitWriter.html#finalizeBoolWriterGif"><span class="hs-identifier hs-var hs-var">finalizeBoolWriterGif</span></a></span></span><span> </span><span id="local-6989586621679165185"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165185"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#flushLeftBitsGif"><span class="hs-identifier hs-var">flushLeftBitsGif</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165185"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#forceBufferFlushing%27"><span class="hs-identifier hs-var">forceBufferFlushing'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165185"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">L.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString)
-&gt; ST s [ByteString] -&gt; ST s ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STRef s [ByteString] -&gt; ST s [ByteString]
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s [ByteString]
forall s. BoolWriteStateRef s -&gt; STRef s [ByteString]
</span><a href="Codec.Picture.BitWriter.html#bwsBufferList"><span class="hs-identifier hs-var hs-var">bwsBufferList</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165185"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span id="local-6989586621679165183"><span class="annot"><a href="Codec.Picture.BitWriter.html#flushLeftBitsGif"><span class="hs-identifier hs-type">flushLeftBitsGif</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Picture.BitWriter.html#BoolWriteStateRef"><span class="hs-identifier hs-type">BoolWriteStateRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679165183"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679165183"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-351"></span><span id="flushLeftBitsGif"><span class="annot"><span class="annottext">flushLeftBitsGif :: BoolWriteStateRef s -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#flushLeftBitsGif"><span class="hs-identifier hs-var hs-var">flushLeftBitsGif</span></a></span></span><span> </span><span id="local-6989586621679165182"><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165182"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>    </span><span id="local-6989586621679165181"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165181"><span class="hs-identifier hs-var">currCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Int -&gt; ST s Int
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Int -&gt; ST s Int) -&gt; STRef s Int -&gt; ST s Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Int
forall s. BoolWriteStateRef s -&gt; STRef s Int
</span><a href="Codec.Picture.BitWriter.html#bwsBitReaded"><span class="hs-identifier hs-var hs-var">bwsBitReaded</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165182"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ST s () -&gt; ST s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679165181"><span class="hs-identifier hs-var">currCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ST s () -&gt; ST s ()) -&gt; ST s () -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>      </span><span id="local-6989586621679165180"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165180"><span class="hs-identifier hs-var">currWord</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s Word8 -&gt; ST s Word8
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">(STRef s Word8 -&gt; ST s Word8) -&gt; STRef s Word8 -&gt; ST s Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; STRef s Word8
forall s. BoolWriteStateRef s -&gt; STRef s Word8
</span><a href="Codec.Picture.BitWriter.html#bwsBitAcc"><span class="hs-identifier hs-var hs-var">bwsBitAcc</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165182"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
forall s. BoolWriteStateRef s -&gt; Word8 -&gt; ST s ()
</span><a href="Codec.Picture.BitWriter.html#pushByte%27"><span class="hs-identifier hs-var">pushByte'</span></a></span><span> </span><span class="annot"><span class="annottext">BoolWriteStateRef s
</span><a href="#local-6989586621679165182"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679165180"><span class="hs-identifier hs-var">currWord</span></a></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">module</span><span> </span><span class="annot"><span class="hs-pragma">&quot;HLint: ignore Reduce duplication&quot;</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span></pre></body></html>